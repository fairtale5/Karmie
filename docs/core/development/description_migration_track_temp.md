# Description Field Migration Tracking

## Overview

This document tracks the migration of document description fields to a standardized format.

## Key Generation

All document keys are generated using [nanoid](https://github.com/ai/nanoid) when documents are created. This is handled automatically by Juno and provides:
- Unique identifiers within collections
- URL-safe strings
- Collision-resistant IDs
- Consistent format across all documents

## Format Standards

### Current Format (Pre-Migration)
```
username:{normalized_handle},author:{author_key}
```

### New Format (Post-Migration)
```
[owner:{principal}],[field:{value}]
```

Key differences:
- Uses brackets for field-value pairs
- Adds commas between pairs for readability
- Owner field always comes first
- Owner uses Principal ID, not document key

## Collection-Specific Formats

### Users Collection
Pre-migration: `username:{normalized_handle},author:{author_key}`
Post-migration: `[owner:{principal}],[username:{name}]`

### Tags Collection
Pre-migration: `name:{normalized_name},author:{author_key}`
Post-migration: `[owner:{principal}],[name:{name}]`

### Votes Collection
Pre-migration: `author:{author_key},target:{target_key},tag:{tag_key}`
Post-migration: `[owner:{principal}],[author:{key}],[target:{key}],[tag:{key}]`

### Reputations Collection
Pre-migration: `user:{user_key},tag:{tag_key}`
Post-migration: `[owner:{principal}],[user:{key}],[tag:{key}]`

## Migration Status

- [ ] Update description_helpers.rs with new format
- [ ] Update structs.rs documentation
- [ ] Update database.md schema
- [ ] Test format parsing
- [ ] Implement migration function
- [ ] Test migration process
- [ ] Deploy changes
- [ ] Verify migrated data

## Important Notes

1. **Principal vs Key**
   - Principal: Used for access control, set by Juno
   - Key: Document identifier, generated by nanoid()
   - Never use Principal as a document key

2. **Format Rules**
   - Owner field always first
   - Commas between field-value pairs
   - Consistent field order per collection
   - Use brackets for field-value pairs

3. **Migration Process**
   - Will be done incrementally
   - Backward compatibility maintained
   - Old format will be supported during transition
   - New documents will use new format

4. **Testing Requirements**
   - Test both formats during transition
   - Verify access control works
   - Check search functionality
   - Validate data integrity

## Migration Process
1. ⬜ Update struct definitions and comments
2. ⬜ Update write operations
3. ⬜ Update read operations
4. ⬜ Update frontend queries
5. ⬜ Update tests

## Search Terms for Code Updates
- `username:`
- `author:`
- `user:`
- `target:`
- `tag:`
- `format!(`
- `description: Some(`
- `matcher: Some(ListMatcher`